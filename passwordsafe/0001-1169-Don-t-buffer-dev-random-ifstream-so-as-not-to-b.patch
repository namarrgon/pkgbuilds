From f8710e31581dda57e7cf7afad696911b2c580ed9 Mon Sep 17 00:00:00 2001
From: Michael Bannister <leahcimb@users.sourceforge.net>
Date: Mon, 21 Apr 2014 14:48:41 +0300
Subject: [PATCH] [1169] Don't buffer /dev/random ifstream so as not to block

Signed-off-by: ronys <ronys@users.sourceforge.net>
---
 src/os/linux/rand.cpp | 4 +++-
 src/os/mac/rand.cpp   | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/os/linux/rand.cpp b/src/os/linux/rand.cpp
index 815f3e4..3f896de 100644
--- a/src/os/linux/rand.cpp
+++ b/src/os/linux/rand.cpp
@@ -77,7 +77,9 @@ void pws_os::GetRandomSeed(void *p, unsigned &slen)
       if (ent_avail >> ent_bits && ent_bits >= 32) {
         slen = ent_bits >= MAX_ENT_BITS ? MAX_ENT_BITS/8 : ent_bits/8;
         data = new char[slen];
-        ifstream rnd("/dev/random");
+        ifstream rnd;
+        rnd.rdbuf()->pubsetbuf(0, 0);
+        rnd.open("/dev/random");
         if (rnd.read(data, slen))
           return;
         else { // trouble reading
diff --git a/src/os/mac/rand.cpp b/src/os/mac/rand.cpp
index 4c1e1f9..c339983 100644
--- a/src/os/mac/rand.cpp
+++ b/src/os/mac/rand.cpp
@@ -77,7 +77,9 @@ void pws_os::GetRandomSeed(void *p, unsigned &slen)
       if (ent_avail >> ent_bits && ent_bits >= 32) {
         slen = ent_bits/8;
         data = new char[slen];
-        ifstream rnd("/dev/random");
+        ifstream rnd;
+        rnd.rdbuf()->pubsetbuf(0, 0);
+        rnd.open("/dev/random");
         if (rnd.read(data, slen))
           return;
         else { // trouble reading
-- 
1.9.2

